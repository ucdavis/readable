trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

#
# Service connection inputs (e.g., `azureSubscription:`) must resolve at compile-time so Azure DevOps can
# authorize and inject the endpoint. Runtime variables from variable groups (e.g., `$(azureServiceConnection)`)
# will not be expanded for these inputs.
#
parameters:
  - name: azureServiceConnectionTest
    type: string
    default: AzureTestDeploy

variables:
  BuildConfiguration: Release
  NodeVersion: 22.x

  # Set to 'true' to have the pipeline deploy/update infra via Bicep before deploying code.
  # You can also override this per environment via variable groups.
  deployInfra: "false"

stages:
  - stage: Build_Test
    displayName: Build & Test
    jobs:
      - job: build_test
        displayName: Build & Test
        steps:
          - task: UseDotNet@2
            displayName: Use .NET SDK (8.x)
            inputs:
              packageType: sdk
              version: 8.x

          - task: NodeTool@0
            displayName: Use Node.js $(NodeVersion)
            inputs:
              versionSpec: $(NodeVersion)

          - script: dotnet restore app.sln
            displayName: dotnet restore

          - script: dotnet build app.sln -c $(BuildConfiguration) --no-restore
            displayName: dotnet build

          # - script: dotnet test app.sln --configuration $(buildConfiguration) --logger trx
          #   displayName: Run server tests

          - script: |
              set -euo pipefail
              cd client
              npm ci
              npm test -- --run
            displayName: client tests (vitest)

          # Build deployable artifacts (web + function) for later stages.
          - script: |
              set -euo pipefail

              # Publish web app
              dotnet publish server/server.csproj -c $(BuildConfiguration) -o "$(Build.ArtifactStagingDirectory)/publish/web"

              # Publish function app
              dotnet publish workers/function.ingest/function_ingest.csproj -c $(BuildConfiguration) -o "$(Build.ArtifactStagingDirectory)/publish/function"
            displayName: Build deploy packages

          - script: mkdir -p "$(Build.ArtifactStagingDirectory)/packages"
            displayName: Prepare package directory

          - task: ArchiveFiles@2
            displayName: Archive web app package
            inputs:
              rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish/web"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/packages/webapp.zip"
              replaceExistingArchive: true

          - task: ArchiveFiles@2
            displayName: Archive function app package
            inputs:
              rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish/function"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/packages/functionapp.zip"
              replaceExistingArchive: true

          - publish: "$(Build.ArtifactStagingDirectory)/packages"
            displayName: Publish deploy packages artifact
            artifact: packages

  - stage: Deploy_Test
    displayName: Deploy (test)
    dependsOn: Build_Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    variables:
      # Create this variable group in Azure DevOps with environment-specific values:
      # - RESOURCE_GROUP, LOCATION, APP_NAME, ENVIRONMENT, DEPLOYMENT_NAME
      # - SQL_ADMIN_LOGIN, SQL_ADMIN_PASSWORD (secret)
      # - (optional) CORS_ALLOWED_ORIGINS, DEPLOY_EVENTGRID_SUBSCRIPTION, EVENTGRID_* tuning vars
      - group: readable-test
    jobs:
      - deployment: deploy_test
        displayName: Deploy to test
        environment: readable-test
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: Checkout repo

                - download: current
                  artifact: packages

                - task: AzureCLI@2
                  displayName: (optional) Deploy infra (Bicep)
                  condition: and(succeeded(), eq(variables['deployInfra'], 'true'))
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      set -euo pipefail
                      cd "$(Build.SourcesDirectory)"
                      env \
                        RESOURCE_GROUP="$(RESOURCE_GROUP)" \
                        LOCATION="$(LOCATION)" \
                        APP_NAME="$(APP_NAME)" \
                        ENVIRONMENT="$(ENVIRONMENT)" \
                        DEPLOYMENT_NAME="$(DEPLOYMENT_NAME)" \
                        SQL_ADMIN_LOGIN="$(SQL_ADMIN_LOGIN)" \
                        SQL_ADMIN_PASSWORD="$(SQL_ADMIN_PASSWORD)" \
                        bash infrastructure/azure/scripts/deploy.sh

                - task: AzureCLI@2
                  name: resolveNames
                  displayName: Resolve app names from infra outputs
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      set -euo pipefail

                      webAppName=$(az deployment group show \
                        --resource-group "$(RESOURCE_GROUP)" \
                        --name "$(DEPLOYMENT_NAME)" \
                        --query "properties.outputs.webAppName.value" -o tsv)

                      functionAppName=$(az deployment group show \
                        --resource-group "$(RESOURCE_GROUP)" \
                        --name "$(DEPLOYMENT_NAME)" \
                        --query "properties.outputs.functionAppName.value" -o tsv)

                      echo "Resolved web app: $webAppName"
                      echo "Resolved function app: $functionAppName"

                      echo "##vso[task.setvariable variable=webAppName]$webAppName"
                      echo "##vso[task.setvariable variable=functionAppName]$functionAppName"

                - task: AzureAppServiceSettings@1
                  displayName: Set Web App runtime settings
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    appName: $(webAppName)
                    resourceGroupName: $(RESOURCE_GROUP)
                    appSettings: |
                      [
                        { "name": "OPENAI_API_KEY", "value": "$(OPENAI_API_KEY)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_ENDPOINT", "value": "$(OTEL_EXPORTER_OTLP_ENDPOINT)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_HEADERS", "value": "$(OTEL_EXPORTER_OTLP_HEADERS)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_PROTOCOL", "value": "grpc", "slotSetting": false },
                        { "name": "OTEL_SERVICE_NAME", "value": "readable.web", "slotSetting": false },
                        { "name": "OTEL_RESOURCE_ATTRIBUTES", "value": "service.name=readable.web,service.environment=$(ENVIRONMENT),deployment.environment.name=$(ENVIRONMENT)", "slotSetting": false },
                        { "name": "PDF_SERVICES_CLIENT_ID", "value": "$(PDF_SERVICES_CLIENT_ID)", "slotSetting": false },
                        { "name": "PDF_SERVICES_CLIENT_SECRET", "value": "$(PDF_SERVICES_CLIENT_SECRET)", "slotSetting": false }
                      ]

                - task: AzureAppServiceSettings@1
                  displayName: Set Function App runtime settings
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    appName: $(functionAppName)
                    resourceGroupName: $(RESOURCE_GROUP)
                    appSettings: |
                      [
                        { "name": "OPENAI_API_KEY", "value": "$(OPENAI_API_KEY)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_ENDPOINT", "value": "$(OTEL_EXPORTER_OTLP_ENDPOINT)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_HEADERS", "value": "$(OTEL_EXPORTER_OTLP_HEADERS)", "slotSetting": false },
                        { "name": "OTEL_EXPORTER_OTLP_PROTOCOL", "value": "grpc", "slotSetting": false },
                        { "name": "OTEL_SERVICE_NAME", "value": "readable.worker", "slotSetting": false },
                        { "name": "OTEL_RESOURCE_ATTRIBUTES", "value": "service.name=readable.worker,service.environment=$(ENVIRONMENT),deployment.environment.name=$(ENVIRONMENT)", "slotSetting": false },
                        { "name": "PDF_SERVICES_CLIENT_ID", "value": "$(PDF_SERVICES_CLIENT_ID)", "slotSetting": false },
                        { "name": "PDF_SERVICES_CLIENT_SECRET", "value": "$(PDF_SERVICES_CLIENT_SECRET)", "slotSetting": false }
                      ]

                - task: AzureWebApp@1
                  displayName: Deploy web app
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    appType: webAppLinux
                    appName: $(webAppName)
                    package: $(Pipeline.Workspace)/packages/webapp.zip

                - task: AzureFunctionApp@2
                  displayName: Deploy function app
                  inputs:
                    azureSubscription: ${{ parameters.azureServiceConnectionTest }}
                    appType: functionAppLinux
                    appName: $(functionAppName)
                    package: $(Pipeline.Workspace)/packages/functionapp.zip
                    isFlexConsumption: true

  # TODO: Deploy_Prod is just a placeholder for now
  - stage: Deploy_Prod
    displayName: Deploy (prod)
    dependsOn: Deploy_Test
    condition: and(succeeded('Deploy_Test'), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    variables:
      # Create this variable group in Azure DevOps with prod values.
      - group: readable-prod
    jobs:
      - deployment: deploy_prod
        displayName: Deploy to prod (placeholder)
        environment: readable-prod
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    echo "TODO: deploy prod (placeholder)"
                  displayName: Placeholder prod deploy step

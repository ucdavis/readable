trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

#
# Service connection inputs (e.g., `azureSubscription:`) must resolve at compile-time so Azure DevOps can
# authorize and inject the endpoint. Runtime variables from variable groups (e.g., `$(azureServiceConnection)`)
# will not be expanded for these inputs.
#
parameters:
  - name: azureServiceConnectionTest
    type: string
    default: AzureTestDeploy
  - name: azureServiceConnectionProd
    type: string
    default: AzureProdDeploy

variables:
  BuildConfiguration: Release
  NodeVersion: 22.x

  # Set to 'true' to have the pipeline deploy/update infra via Bicep before deploying code.
  # You can also override this per environment via variable groups.
  deployInfra: "false"

stages:
  - stage: Build_Test
    displayName: Build & Test
    jobs:
      - job: build_test
        displayName: Build & Test
        steps:
          - task: UseDotNet@2
            displayName: Use .NET SDK (8.x)
            inputs:
              packageType: sdk
              version: 8.x

          - task: NodeTool@0
            displayName: Use Node.js $(NodeVersion)
            inputs:
              versionSpec: $(NodeVersion)

          - script: dotnet restore app.sln
            displayName: dotnet restore

          - script: dotnet build app.sln -c $(BuildConfiguration) --no-restore
            displayName: dotnet build

          # - script: dotnet test app.sln --configuration $(buildConfiguration) --logger trx
          #   displayName: Run server tests

          - script: |
              set -euo pipefail
              cd client
              npm ci
              npm test -- --run
            displayName: client tests (vitest)

          # Build deployable artifacts (web + function) for later stages.
          - script: |
              set -euo pipefail

              # Publish web app
              dotnet publish server/server.csproj -c $(BuildConfiguration) -o "$(Build.ArtifactStagingDirectory)/publish/web"

              # Publish function app
              dotnet publish workers/function.ingest/function_ingest.csproj -c $(BuildConfiguration) -o "$(Build.ArtifactStagingDirectory)/publish/function"
            displayName: Build deploy packages

          - script: mkdir -p "$(Build.ArtifactStagingDirectory)/packages"
            displayName: Prepare package directory

          - task: ArchiveFiles@2
            displayName: Archive web app package
            inputs:
              rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish/web"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/packages/webapp.zip"
              replaceExistingArchive: true

          - task: ArchiveFiles@2
            displayName: Archive function app package
            inputs:
              rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish/function"
              includeRootFolder: false
              archiveType: zip
              archiveFile: "$(Build.ArtifactStagingDirectory)/packages/functionapp.zip"
              replaceExistingArchive: true

          - publish: "$(Build.ArtifactStagingDirectory)/packages"
            displayName: Publish deploy packages artifact
            artifact: packages

  - template: infrastructure/azure/pipelines/templates/deploy-stage.yml
    parameters:
      stageName: Deploy_Test
      displayName: Deploy (test)
      dependsOn: Build_Test
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
      variableGroup: readable-test
      environmentName: readable-test
      azureSubscription: ${{ parameters.azureServiceConnectionTest }}

  - template: infrastructure/azure/pipelines/templates/deploy-stage.yml
    parameters:
      stageName: Deploy_Prod
      displayName: Deploy (prod)
      dependsOn: Deploy_Test
      condition: and(succeeded('Deploy_Test'), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
      variableGroup: readable-prod
      environmentName: readable-prod
      azureSubscription: ${{ parameters.azureServiceConnectionProd }}
